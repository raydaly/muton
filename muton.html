<!DOCTYPE html> 
<!-- 
	TODO to get first two screens like Futon
	startPg
	- x Overview
	- Configuration
	- Replicator
	- Status
	- Test Suite
	dbList
	- add database
	- next, previous
	- change number of items on page
	- number of documents in bubble with one call each to api (make advance option)
	- showing 1 of x
	docList
	- 
	
-->
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Muton for CouchDB</title>
	<meta name="viewport" content="user-scalable=no, width=device-width" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<link href="http://code.jquery.com/mobile/latest/jquery.mobile.min.css" rel="stylesheet" type="text/css" />
	<script src="http://code.jquery.com/jquery-1.6.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/latest/jquery.mobile.min.js"></script>
	<style>
		.xof {text-align: center;}
		#statusErrorMsg {color: red;}
	</style>
</head>
<body>
	<div data-role="page" id="startPg" data-add-back-btn="true">
		<div data-role="header">
			<h1>Muton for CouchDB</h1>
			<a href="#aboutPg" class="ui-btn-right" data-icon="info">About</a>
		</div>
		<div data-role="content">
			<p>This page will be about login in</p>
			<ul data-role="listview" data-theme="g">
				<li><a href="#dbListPg">Overview</a></li>
				<li><a href="#">Configuration</a></li>
				<li><a href="#">Replicator</a></li>
				<li><a href="#statusPg">Status</a></li>
				<li><a href="#">Test Suite</a></li>
			</ul>
			
		</div>
	</div><!-- /startPg -->
	
	<div data-role="page" id="aboutPg" data-add-back-btn="true">
		<div data-role="header">
			<h1>About Muton</h1>
		</div>
		<div class="branding">Muton For CouchDB</div>
		<div data-role="content">
			<p>Muton is an administration console for CouchDB meant for mobile devices.</p> 
			<p>Support for various mobile devices and most modern web browsers is possible using the jQuery Mobile library. See their <a href="http://jquerymobile.com/gbs/">page on device support</a>.</p>
			<p>Project is maintained on GitHub (future).</p>
		</div>
	</div><!-- /about -->

	<div data-role="page" id="dbListPg" data-add-back-btn="true">
		<div data-role="header">
			<h1>database list</h1>
			<a href="#createDbPg" class="ui-btn-right" data-icon="plus" data-rel="dialog">Create DB</a>
		</div>
		<div data-role="content">
			<ul id="dbListUL" data-role="listview" data-theme="g" data-filter="true">
				<li><a href="#docListPg">db1</a><span class="ui-li-count">47</span></li>
			</ul>
		</div>
		<fieldset class="ui-grid-a">
			<div class="ui-block-a"><a id="butDbListPrevious" href="#" data-role="button" data-icon="arrow-l">Previous</a></div>
			<div class="ui-block-b"><a id="butDbListNext" href="#" data-role="button" data-icon="arrow-r" data-iconpos="right">Next</a></div>	   
		</fieldset>
	</div><!-- /dbListPg -->

	<div data-role="page" id="docListPg" data-add-back-btn="true">
		<div data-role="header">
			<h1>document list</h1>
			<a href="#dbListAdvancePg" class="ui-btn-right" data-icon="arrow-r">Advanced</a>
		</div>
		<div data-role="content">
			<ul id="docsListUL" data-role="listview" data-theme="g" data-filter="true">
				<li><a href="#docPg">doc id here</a><span class="ui-li-count">47</span></li>
			</ul>
		</div>
		<fieldset class="ui-grid-a">
			<div class="ui-block-a"><a id="butDocListPrevious" href="#" data-role="button" data-icon="arrow-l">Previous</a></div>
			<div class="ui-block-b"><a id="butDocListNext"  href="#" data-role="button" data-icon="arrow-r" data-iconpos="right">Next</a></div>	   
		</fieldset>
	</div><!-- /docListPg -->

	<div data-role="page" id="docPg" data-add-back-btn="true">
		<div data-role="header">
			<h1>view document</h1>
			<a href="#docAdvancePg" class="ui-btn-right" data-icon="arrow-r">Advanced</a>
		</div>
		<div data-role="content">
			<ul data-role="listview" data-theme="g" data-filter="true">
				<li><a href="#docPg">key here
					<p class="ui-li-desc">value here</p>
				</a></li>
			</ul>
		</div>
	</div><!-- /docPg -->

	<div data-role="page" id="statusPg" data-add-back-btn="true">
		<div data-role="header">
			<h1>Status</h1>
		</div>
		<div data-role="content">
			<div data-role="fieldcontain">
				<label for="statusPoll">Poll interval in seconds:</label>
			 	<input type="range" name="statusPoll" id="statusPoll" value="5" min="0" max="30"  />
			</div>
			<ul id="statusListUL" data-role="listview" data-theme="g">
				<li><h3>data.type</h3>
					<p>data.task</p>
					<p class="ui-li-aside">data.pid</p>
					<p>data.status</p>
				</li>
			</ul>
		</div>
	</div><!-- /statusPg -->
	
	<div data-role="page" id="createDbPg">
		<div data-role="header">
			<h1>Create New Database</h1>
			<a href="#docAdvancePg" class="ui-btn-right" data-icon="arrow-r">Advanced</a>
		</div>
		<div data-role="content">
			Please enter the name of the database. Note that only lowercase characters (a-z), digits (0-9), or any of the characters _, $, (, ), +, -, and / are allowed.
			<div data-role="fieldcontain">
				<label for="newDbName" class="select">Database name: </label>
				<input type="text" name="newDbName" id="newDbName" value=""  />
			</div>
			<div id="statusErrorMsg"></div>
		</div>
		<a id="butCreateDb" href="#" data-role="button" data-icon="check">Create</a>
		<!--  butCreateDb$('#createDbPg').dialog('close') -->
	</div><!-- /statusPg -->
	
<script>
$(document).ready(function() {
   $(".dbListA").live("click", function(){
		//alert('clicked anchor id='+this.id)
		muton.populateDocsList(this.id.substring(3));
		$.mobile.changePage ($("#docListPg"));
	});
    muton.populateDbList(muton.dbListStart,muton.dbListIncrement);
    //muton.populateDocsList("books");

	//previous and next for docList
	$("#butDocListPrevious").live("click", function(){
		alert('previous docList');
	});

	$("#butDocListNext").live("click", function(){
		alert('next docList');
	});

	//previous and next for dbList
	$("#butDbListPrevious").live("click", function(){
		var x=muton.dbStart-muton.dbLimit;
		if (x>=0) {
			muton.dbStart=x;
		}
		muton.populateDbList();
	});

	$("#butDbListNext").live("click", function(){
		//alert('next dbList');
		var x=muton.dbStart+muton.dbLimit;
		if (x<muton.dbMax) {
			muton.dbStart=x;
		}
		muton.populateDbList();
	});

	//clear interval and set timeout for status page
	//muton.statusInterval is interval in seconds
	$('#statusPg').live('pagebeforeshow',function(event, ui){
	  muton.populateStatus();
	  muton.status=setInterval(muton.populateStatus,1000*muton.statusInterval);
	});

	$('#statusPg').live('pagehide',function(event, ui){
	  clearInterval(muton.status);
	});

   $("#statusPoll").live("change", function(){
		var x=parseInt($("#statusPoll").val());
		//alert('statusPoll='+x)
		if (x!=muton.statusInterval && x>0 & x<10000){
			muton.statusInterval=x;
			clearInterval(muton.status);
			muton.status=setInterval(muton.populateStatus,1000*muton.statusInterval);
		}
		muton.populateStatus();
	});
	
	//action from dialog for creating new database
	$("#butCreateDb").live("click", function(){
		//alert('clicked anchor id='+this.id)
		var errorMsg="";
		var x=$.trim($("#newDbName").val());
		if (x.length==0){
			errorMsg="Please enter a name.";
		}else{
			//TODO regex to all only legal names (a-z), digits (0-9), or  _, $, (, ), +, -, and /
			var url="/"+x+"/";
			$.ajax({
				type: 'PUT',
				url: url,
				success: function(){
					$('#createDbPg').dialog('close');
					//TODO repopulate dblist - maybe sould be on show event????
				    muton.populateDbList(muton.dbListStart,muton.dbListIncrement);
				}
			});
		}
		$("#statusErrorMsg").html(errorMsg);	
	});
});

var muton={
	docsLimit: 10, 
	dbLimit: 10,
	dbStart: 0,
	dbMax: 0,
	statusInterval: 5, //default to 5 seconds
	populateDbList2 : function(){
		var url='/_all_dbs';
		$.getJSON(url, function(data) {
			//alert('Got json of all databases='+data);
			var x="";
			muton.dbMax=data.length;
			var y=data.slice(muton.dbStart,muton.dbStart+muton.dbLimit);
			for (var i=0; i<y.length;i++){
				x=x+'<li class="dbListA" id="db_'+y[i]+'" ><a href="#">'+y[i]+'</a>';
				x=x+'<span class="ui-li-count">47</span></li>';
			}
			x=x+'<li data-role="list-divider" class="xof">Showing '+(muton.dbStart+1)+'-'+(parseInt(muton.dbStart)+i)+' of '+(parseInt(muton.dbMax))+' databases</li>';
			$("#dbListUL").html(x).listview('refresh');
		});
	},
	
	populateDbList : function(){
		var url='/_all_dbs';
		$.getJSON(url, function(data) {
			//alert('Got json of all databases='+data);
			var x="";
			muton.dbMax=data.length;
			var y=data.slice(muton.dbStart,muton.dbStart+muton.dbLimit);
			/*
["_users","books","edues","muton","nbi","nbi20100705","nbi_final","nbi_final2","talk","ztemp1","ztemp2","ztemp3","ztemp41","ztemp42"]
			*/
			for (var i=0; i<y.length;i++){
				x=x+'<li class="dbListA" id="db_'+y[i]+'" ><a href="#">'+y[i]+'</a>';
				x=x+'<span id="docCount'+i+'" class="ui-li-count"></span></li>';
			}
			x=x+'<li data-role="list-divider" class="xof">Showing '+(muton.dbStart+1)+'-'+(parseInt(muton.dbStart)+i)+' of '+(parseInt(muton.dbMax))+' databases</li>';
			$("#dbListUL").html(x);
			//get record count for each database
			//TODO callback function is not getting j
			for (var j=0; j<y.length;j++){
				var url='/'+y[j]+'/';
				$.getJSON(url, function(data) {
					$("#docCount"+j).html(data.doc_count);
					var a=j;
				});
			}
			$("#dbListUL").listview('refresh');
		});
	},
	
	populateDocsList : function(db){
		//get all documents for a database in this instance of couchdb, populate list, refresh list
		//_all_docs?startkey="doc2"&limit=2  
		//http://127.0.0.1:5984/nbi20100705/_all_docs?startkey=%22_design%2F%22&endkey=%22_design0%22&include_docs=true 
			//startkey=?
			//limit will be 10, 25, 50, 100 - hardcoding 10 to start
		//alert("@populateDocsList="+db);
		var url="/"+db+"/_all_docs/?limit="+muton.docsLimit;
		$.getJSON(url, function(data) {
			//alert('Got json of all databases='+data);
			var total_rows=data.total_rows;
			var offset=data.offset;
			var rows=data.rows;
			var x="";
			for (var i=0; i<rows.length;i++){
				//<li><a id="db_name" href="#docPg">doc id here</a><span class="ui-li-count">47</span></li>
				x=x+'<li><a id="doc_'+rows[i].id+'" href="#docPg">'+rows[i].id+'<p>'+rows[i].value.rev+'</p></a></li>';
			}
			//test=x; //global for testing
			$("#docsListUL").html(x).listview('refresh');
			//$.mobile.changePage ($("#docListPg"));
			/*
			{"total_rows":256,"offset":0,"rows":[
			{"id":"1","key":"1","value":{"rev":"14-b6b36469b4e1deb02cae3e358b6d3348"}},
			{"id":"10","key":"10","value":{"rev":"29-3eb82d0e82c7b4a47b0d8c328520ac99"}},
			{"id":"100","key":"100","value":{"rev":"1-70cd178b4fe31b9dbc67e0f217719781"}},
			*/
		});
	},
	populateStatus : function(){
		var x="";
		//$("#statusPoll").val(muton.statusInterval);
		var url="/_active_tasks";
		$.getJSON(url, function(data) {
			//alert('Got json of all active tasks');
			for (var i=0; i<data.length;i++){
				x=x+'<li><h3>'+data[i].type+'</h3><p>'+data[i].task;
				x=x+'</p><p class="ui-li-aside">'+data[i].pid;
				x=x+'</p><p>'+data[i].status+'</p></li>';
			}
			if (i==0){
				x="<li>No tasks running</li>";
			}
			$("#statusListUL").html(x).listview('refresh');
		});
	}
}
/*
{"db_name":"nbi_final","doc_count":255,"doc_del_count":13,"update_seq":268,"purge_seq":0,"compact_running":false,"disk_size":14397537,"instance_start_time":"1307067097241345","disk_format_version":5,"committed_update_seq":268}
*/

</script>

</body></html>
