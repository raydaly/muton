<!DOCTYPE html> 
<!-- 
ADD Login to top level screen and test if logged in everytime screen shown.

BUGS
	database list: next, next, next; change rows to 100, cannot get back to first database
	popus blow the back stack
	
CHECK SESSION FIRST

DONE Creating a database (PUT /database) 
DONE, BUT COMMENTED OUT Deleting a database (DELETE /database)
* Creating a design document (PUT /database/_design/app)
* Updating a design document (PUT /database/_design/app?rev=1-4E2)
* Deleting a design document (DELETE /database/_design/app?rev=1-6A7)
* Triggering compaction (POST /_compact)
DONE Reading the task status list (GET /_active_tasks)
* Restarting the server (POST /_restart)
DONE Reading the active configuration (GET /_config)
* Updating the active configuration (PUT /_config)
)))))))))))))))) Admin must be logged in to do this operation.


TODO to get first two screens like Futon
	startPg
	- x Overview
	- Configuration
		x get config
		x list sections
		x list options/value
		edit value
	- Replicator
	- Status
	- n/a Test Suite
	- Login (todo: failure not handled correctly)
	dbListPg
	- x add database
		TODO if error (not permissions, ask to log in)
	- x next, previous
	- x change number of items on page
	- number of documents in bubble with one call each to api (make advance option)
		- TODO bug with variable j
	- x showing 1 of x
	docListPg
		extra
			new document
			x delete database
			security
			x compact and cleanup
			x jump to document
		view
			x all
			x design
			temp views
			run view
		x next, previous, rows
	fieldListPg
		x don't allow edit of _fields like _id, _rev, etc.
		x highlight value not key
		x edit
		attachments object not displayed properly
		extra
			save document
			add field
			upload attachment
			delete document
			change view/display/
				key/value
				value/key
		
	editPg
	-  x save button working
		NOTE: save document still needs to work
-->
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Muton for CouchDB</title>
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<!-- 
	<link href="http://code.jquery.com/mobile/latest/jquery.mobile.min.css" rel="stylesheet" type="text/css" />
	<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
	<script src="http://code.jquery.com/mobile/latest/jquery.mobile.min.js"></script>
-->
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0rc1/jquery.mobile-1.0rc1.min.css" />
	<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.0rc1/jquery.mobile-1.0rc1.min.js"></script>
<!--
	<link rel="stylesheet" href="jquery.mobile-1.0rc1.min.css" />
	<script src="jquery-1.6.4.min.js"></script>
	<script src="jquery.mobile-1.0rc1.min.js"></script>
-->
	
	<style>
		.xof {text-align: center;}
		.errorMsg {color: red;}
		#fromRemoteDiv {display: none;}
		#toRemoteDiv {display: none;}
		
	</style>
</head>
<body>

	<div data-role="page" id="startPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>Muton for CouchDB</h1>
		</div>
		<div data-role="content">
			<ul data-role="listview" data-inset="true">
				<li><a id="startDbListPg" href="#dbListPg">Databases</a></li>
				<li><a href="#configPg">Configuration</a></li>
				<li><a id="startReplicatePg" href="#replicatePg">Replicator</a></li>
				<li><a href="#statusPg">Status</a></li>
				<li><a href="#loginPg" data-rel="dialog">Login</a></li>
				<!-- <li><a href="#">Test Suite</a></li> -->
			</ul>
		</div>
	</div><!-- /startPg -->
	
	<div data-role="page" id="loginPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>Login</h1>
		</div>
		<div data-role="content">
			<p>Login to CouchDB with your name and password.</p>
			<div class="errorMsg" id="loginErrorMsg"></div>			<div data-role="fieldcontain">	
				<label for="username">Username: </label>
				<input type="text" name="username" id="username" />
				<label for="password">Password: </label>
				<input type="password" name="password" id="password" />
				<a id="butLoginPg" href="#" data-role="button">Login</a>
			</div>
		</div>
	</div><!-- /about -->

	<div data-role="page" id="aboutPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>About Muton</h1>
		</div>
		<div class="branding">Muton For CouchDB</div>
		<div data-role="content">
			<p>Muton is an administration console for CouchDB meant for mobile devices.</p> 
			<p>Support for various mobile devices and most modern web browsers is possible using the jQuery Mobile library. See their <a href="http://jquerymobile.com/gbs/">page on device support</a>.</p>
			<p>Project is maintained on GitHub (future).</p>
		</div>
	</div><!-- /about -->

	<div data-role="page" id="rowDbPg" data-theme="e">
		<div data-role="header">
			<h1>Change # of Rows</h1>
		</div>
		<div data-role="content">
			<div data-role="fieldcontain">
			 	<fieldset data-role="controlgroup" data-role="controlgroup">
					<input type="radio" name="rowsDb" id="rowsDb-5" class="rowsDbClass" value="5" />
					<label for="rowsDb-5">5</label>
					<input type="radio" name="rowsDb" id="rowsDb-10" class="rowsDbClass" value="10" />
					<label for="rowsDb-10">10</label>
					<input type="radio" name="rowsDb" id="rowsDb-25" class="rowsDbClass" value="25" />
					<label for="rowsDb-25">25</label>
					<input type="radio" name="rowsDb" id="rowsDb-50" class="rowsDbClass" value="50" />
					<label for="rowsDb-50">50</label>
					<input type="radio" name="rowsDb" id="rowsDb-100" class="rowsDbClass" value="100" />
					<label for="rowsDb-100">100</label>
			    </fieldset>
			</div>
			<a href="#dbListPg" data-rel="back"  data-role="button">Close</a>
		</div>
	</div><!-- /rowDbPg -->

	<div data-role="page" id="dbListPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>database list</h1>
			<a href="#createDbPg" class="ui-btn-right" data-icon="plus" data-rel="dialog">Create DB</a>
		</div>
		<div data-role="content">
			<ul id="dbListUL" data-role="listview" data-inset="true" data-filter="true">
				<li><a href="#docListPg">db1</a><span class="ui-li-count">47</span></li>
			</ul>
		</div>
		<fieldset class="ui-grid-b">
			<div class="ui-block-a"><a id="butDbListPrevious" href="#" data-role="button" data-icon="arrow-l">Previous</a></div>
			<div class="ui-block-b"><a href="#rowDbPg"  data-rel="dialog" data-role="button">Rows</a></div>
			<div class="ui-block-c"><a id="butDbListNext" href="#" data-role="button" data-icon="arrow-r" data-iconpos="right">Next</a></div>	   
		</fieldset>
	</div><!-- /dbListPg -->

	<div data-role="page" id="docListPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>document list</h1>
			<a href="#dbListMorePg" class="ui-btn-right" data-icon="arrow-r">More</a>
		</div>
		<div data-role="content">
			<div data-role="fieldcontain">
				<label for="jumpDocInput">Jump to </label>
				<input type="search" name="jumpDocInput" id="jumpDocInput" value="" placeholder="doc id"  />
			</div>
			<ul id="docsListUL" data-role="listview" data-inset="true">
				<li><a href="#docPg">doc id here</a><span class="ui-li-count">47</span></li>
			</ul>
			<div data-role="fieldcontain">
				<label for="docViewInput">View </label>
				<select name="docViewInput" id="docViewInput" data-native-menu="false">
					<option value="all">All Documents</option>
					<option value="design">Design documents</option>
					<option value="temporary">Temporary View</option>
					<option value="runView">Run Views</option>
				</select>
			</div>
		</div>
		<fieldset class="ui-grid-a">
			<div class="ui-block-a"><a id="butDocListPrevious" href="#" data-role="button" data-icon="arrow-l">Previous</a></div>
			<div class="ui-block-b"><a id="butDocListNext"  href="#" data-role="button" data-icon="arrow-r" data-iconpos="right">Next</a></div>	   
		</fieldset>
	</div><!-- /docListPg -->
	
	<div data-role="page" id="runViewsPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>Run Views</h1>
		</div>
		<div data-role="content">
			<ul id="runViewsUL" data-role="listview" data-inset="true">
				<li data-role="list-divider">Design Doc 1</li>
				<li><a href="#" id="" class="">View 1</a></li>
				<li><a href="#" id="" class="">View 2</a></li>
				<li data-role="list-divider">Design Doc 2</li>
				<li><a href="#" id="" class="">View 1</a></li>
				<li><a href="#" id="" class="">View 2</a></li>
			</ul>
		</div>
	</div><!-- /runViewsPg -->	

	<div data-role="page" id="dbListMorePg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>More Actions</h1>
		</div>
		<div data-role="content">
			<ul id="" data-role="listview" data-inset="true">
				<li id="#butNewDoc"><a href="#">New Document</a></li>
				<li><a href="#dbSecurityPg" data-rel="dialog">Security</a></li>
				<li><a href="#compactPg" data-rel="dialog">Compact and Cleanup</a></li>
				<li><a href="#dbDeletePg" data-rel="dialog">Delete Database</a></li>
			</ul>
		</div>
	</div><!-- /dbListMorePg -->	

	<div data-role="page" id="dbSecurityPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>Database Security</h1>
		</div>
		<div data-role="content">
			dbSecurityPg
		</div>
	</div><!-- /dbSecurityPg -->	

	<div data-role="page" id="compactPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>Compact Database</h1>
		</div>
		<div data-role="content">
		 <fieldset data-role="none">
	         	<input type="radio" name="compact" id="compact-1" class="compactClass" value="database" checked="checked" />
	         	<label for="compact-1">Compact Database</label>
				Compacting a database removes deleted documents and previous revisions. It is an irreversible operation and may take a while to complete for large databases.

	         	<input type="radio" name="compact" id="compact-2" class="compactClass" value="views"  />
	         	<label for="compact-2">Compact Views</label>
				View compaction will affect all views in this design document. This operation may take some time to complete. Your views will still operate normally during compaction.

	         	<input type="radio" name="compact" id="compact-3" class="compactClass" value="cleanup"  />
	         	<label for="compact-3">Cleanup Views</label>
				Cleaning up views in a database removes old view files still stored on the filesystem. It is an irreversible operation.
		</fieldset>
			
			<a id="butCompactDb" href="#" data-role="button" data-icon="check">Run</a>
			<a data-rel="back" href="#dbListMorePg" data-role="button" data-icon="delete">Cancel</a>
		</div>
	</div><!-- /compactPg -->	

	<div data-role="page" id="dbDeletePg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>Delete Database</h1>
		</div>
		<div data-role="content">
			Are you sure you want to delete this database? Note that this is an irreversible operation! 
			<a id="butDeleteDb" href="#" data-role="button" data-icon="check">Delete Database</a>
			<a data-rel="back" href="#dbListMorePg" data-role="button" data-icon="delete">Cancel</a>
		</div>
	</div><!-- /dbDeletePg -->	

	<div data-role="page" id="docPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>view document</h1>
			<a href="#docAdvancePg" class="ui-btn-right" data-icon="arrow-r">Advanced</a>
		</div>
		<div data-role="content">
			<ul id="fieldListUL" data-role="listview" data-inset="true" data-filter="true">
				<li><a href="#docPg">key here
					<p class="ui-li-desc">value here</p>
				</a></li>
			</ul>
		</div>
	</div><!-- /docPg -->

	<div data-role="page" id="statusPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>Status</h1>
		</div>
		<div data-role="content">
			<div data-role="fieldcontain">
				<label for="statusPoll">Poll interval in seconds:</label>
			 	<input type="range" name="statusPoll" id="statusPoll" value="5" min="0" max="30"  />
			</div>
			<div class="errorMsg" id="statusErrorMsg"></div>
			<ul id="statusListUL" data-role="listview" data-inset="true">
			</ul>
		</div>
	</div><!-- /statusPg -->
	
	<div data-role="page" id="createDbPg" data-theme="e">
		<div data-role="header">
			<h1>Create New Database</h1>
		</div>
		<div data-role="content">
			Please enter the name of the database. Note that only lowercase characters (a-z), digits (0-9), or any of the characters _, $, (, ), +, -, and / are allowed.
			<div data-role="fieldcontain">
				<label for="newDbName" class="select">Database name: </label>
				<input type="text" name="newDbName" id="newDbName" value=""  />
			</div>
			<div class="errorMsg" id="createDbErrorMsg"></div>
		</div>
		<a id="butCreateDb" href="#" data-role="button" data-icon="check">Create</a>
		<!--  butCreateDb$('#createDbPg').dialog('close') -->
	</div><!-- /createDbPg -->
	
	<div data-role="page" id="editPg" data-theme="e" data-add-back-btn="true" >
		<div data-role="header">
			<h1>Edit</h1>
		</div>
		<div data-role="content">
			<div class="errorMsg" id="editErrorMsg"></div>
			<div data-role="fieldcontain">
				<label id="editKeyLabel" for="editKey" class="select">Key: </label>
				<input type="text" name="editKey" id="editKey" value="value"  />
			</div>
		</div>
		<a id="butEditSave" href="#" data-role="button" data-icon="check">Save</a>
		<a data-rel="back" href="#docPg" data-role="button" data-icon="delete">Cancel</a>
	</div><!-- /editPg -->


	<div data-role="page" id="replicatePg" data-theme="e" data-add-back-btn="true">
		<div data-role="header">
			<h1>Replicate Changes</h1>
		</div>
		<div data-role="content">
			<div class="errorMsg" id="replicateErrorMsg"></div>
			
			<div data-role="fieldcontain">
				<label for="fromSlider">From:</label>
				<select name="fromSlider" id="fromSlider" data-role="slider">
					<option value="true">Local</option>
					<option value="false">Remote</option>
				</select> 
			</div>
			<div data-role="fieldcontain" id="fromLocalDiv">
				<label for="fromLocal" class="select">Local database:</label>
				<select name="fromLocal" id="fromLocal" data-native-menu="false">
					<option value="standard"></option>
				</select>
			</div>
			<div data-role="fieldcontain" id="fromRemoteDiv">	
				<label for="fromRemote">Remote database: </label>
				<input type="text" name="fromRemote" id="fromRemote" value="http://"  />
			</div>
			<div data-role="fieldcontain">
				<label for="toSlider">To:</label>
				<select name="toSlider" id="toSlider" data-role="slider">
					<option value="true">Local</option>
					<option value="false">Remote</option>
				</select> 
			</div>
			<div data-role="fieldcontain" id="toLocalDiv">
				<label for="toLocal" class="select">Local database:</label>
				<select name="toLocal" id="toLocal" data-native-menu="false">
					<option value="standard"></option>
				</select>
			</div>
			<div data-role="fieldcontain" id="toRemoteDiv">
				<label for="toRemote">Remote database: </label>
				<input type="text" name="toRemote" id="toRemote" value="http://"  />
			</div>

			<a id="butReverse" href="#" data-role="button" data-icon="refresh">Reverse</a>

			<div data-role="fieldcontain">
				<fieldset data-role="controlgroup">
					<input type="checkbox" name="continuous" id="continuous" />
					<label for="continuous">Continuous</label>
				</fieldset>
			</div>
			<div data-role="fieldcontain">
				<a id="butReplicator" href="#" data-role="button" data-icon="check">Replicate</a>
			</div>
		</div>
		<div data-role="content">
			<ul id="replicatorEventUL" data-role="listview" data-theme="a" data-inset="true">
				<li data-role="list-divider">Events</li>
				<li id="replicatorEvent"></li>
			</ul>
		</div>
	</div><!-- /replicatePg -->
	
	<div data-role="page" id="replicatePg2" data-theme="e" data-close-btn-text="Back">
		<div data-role="header">
			<h1>Replicate Changes</h1>
		</div>
		<div data-role="content">
			<div class="errorMsg" id="replicateErrorMsg"></div>
			<div data-role="fieldcontain">
				<label for="fromSlider">From:</label>
				<select name="fromSlider" id="fromSlider" data-role="slider">
					<option value="true">Local</option>
					<option value="false">Remote</option>
				</select> 
			</div>
			<div data-role="fieldcontain" id="fromLocalDiv">
				<label for="fromLocal" class="select">Local database:</label>
				<select name="fromLocal" id="fromLocal" data-native-menu="false">
					<option value="standard">Standard: 7 day</option>
					<option value="rush">Rush: 3 days</option>
					<option value="express">Express: next day</option>
					<option value="overnight">Overnight</option>
				</select>
			</div>
			<div data-role="fieldcontain" id="fromRemoteDiv">	
				<label for="fromRemote">Remote database: </label>
				<input type="text" name="fromRemote" id="fromRemote" value="http://"  />
			</div>
			<div data-role="fieldcontain">
				<label for="toSlider">To:</label>
				<select name="toSlider" id="toSlider" data-role="slider">
					<option value="true">Local</option>
					<option value="false">Remote</option>
				</select> 
			</div>
			<div data-role="fieldcontain" id="toLocalDiv">
				<label for="toLocal" class="select">Local database:</label>
				<select name="toLocal" id="toLocal" data-native-menu="false">
					<option value="standard">Standard: 7 day</option>
					<option value="rush">Rush: 3 days</option>
					<option value="express">Express: next day</option>
					<option value="overnight">Overnight</option>
				</select>
			</div>
			<div data-role="fieldcontain" id="toRemoteDiv">
				<label for="toRemote">Remote database: </label>
				<input type="text" name="toRemote" id="toRemote" value="http://"  />
			</div>
		
		<!--
			<p>From: (select local or remote)</p>
			<div data-role="collapsible-set">
				<div data-role="collapsible" data-collapsed="false" data-theme="a">
					<h3>Local</h3>
					<div data-role="fieldcontain" id="toLocalDiv3">
						<label for="toLocal3" class="select">Local database:</label>
						<select name="toLocal3" id="toLocal3" data-native-menu="false">
							<option value="standard">Standard: 7 day</option>
							<option value="rush">Rush: 3 days</option>
							<option value="express">Express: next day</option>
							<option value="overnight">Overnight</option>
						</select>
					</div>
				</div>
				<div data-role="collapsible" data-theme="a">
					<h3>Remote</h3>
					<div data-role="fieldcontain" id="toRemoteDiv3">
						<label for="toRemote">Remote database: </label>
						<input type="text" name="toRemote" id="toRemote" value="http://"  />
					</div>
				</div>
			</div>
			<p>To: (select local or remote)</p>
			<div data-role="collapsible-set">
				<div data-role="collapsible" data-collapsed="false" data-theme="b">
					<h3>Local</h3>
					<div data-role="fieldcontain" id="toLocalDiv2">
						<label for="toLocal2" class="select">Local database:</label>
						<select name="toLocal2" id="toLocal2" data-native-menu="false">
							<option value="standard">Standard: 7 day</option>
							<option value="rush">Rush: 3 days</option>
							<option value="express">Express: next day</option>
							<option value="overnight">Overnight</option>
						</select>
					</div>
				</div>
				<div data-role="collapsible" data-theme="b">
					<h3>Remote</h3>
					<div data-role="fieldcontain" id="toRemoteDiv2">
						<label for="toRemote2">Remote database: </label>
						<input type="text" name="toRemote2" id="toRemote2" value="http://"  />
					</div>
				</div>
			</div>
		-->
			<a id="butReverse" href="#" data-role="button" data-icon="refresh">Reverse</a>
				
			<div data-role="fieldcontain">
				<fieldset data-role="controlgroup">
					<input type="checkbox" name="continuous" id="continuous" />
					<label for="continuous">Continuous</label>
				</fieldset>
			</div>
			<a id="butReplicator" href="#" data-role="button" data-icon="check">Replicate</a>
			
		</div>
	</div><!-- /replicatePg -->
	
<!-- sever pages not used due to same domain issue -->
	
	<div data-role="page" id="serverPg" data-theme="e">
		<div data-role="header">
			<h1>Muton</h1>
			<a href="#aboutPg" class="ui-btn-right" data-icon="info">About</a>
		</div>
		<div data-role="content">
			<ul id="serverListUL" data-role="listview" data-inset="true">
				<li class="serverListA"  id="http://127.0.0.1:5984"><a href="#startPg">Local Host</a></li>
			</ul>
			<fieldset class="ui-grid-a">
				<div class="ui-block-a"><a href="#serverDeletePg" data-rel="dialog" data-role="button" data-icon="delete" data-iconpos="left">Delete</a></div>	   
				<div class="ui-block-b"><a href="#serverNewPg"  data-rel="dialog" data-role="button" data-icon="add"  data-iconpos="right">New</a></div>
			</fieldset>
		</div>
	</div><!-- /serverPg -->
	
	<div data-role="page" id="serverDeletePg" data-theme="e">
		<div data-role="header">
			<h1>Server Delete</h1>
		</div>
		<div data-role="content">
			<div data-role="fieldcontain">
				<p>Select servers to delete</p>
			 	<fieldset id="serverDeleteGroup" data-role="controlgroup" data-role="controlgroup">
					<input type="radio" name="name" id="name" value="0" />
					<label for="name">name</label>
			    </fieldset>
				<a id="butDeleteServer" href="#" data-role="button" data-icon="delete" data-iconpos="right">Delete</a>	   
			</div>
		</div>
	</div><!-- /serverDeletePg -->
	
	<div data-role="page" id="serverNewPg" data-theme="e">
		<div data-role="header">
			<h1>New Server</h1>
		</div>
		<div data-role="content">
			<div data-role="fieldcontain">
				<label for="serverName">Server Name:</label>
				<input type="text" name="serverName" id="serverName" value=""  />
			</div>
			<div data-role="fieldcontain">
				<label for="serverAddress">Server Address:</label>
				<input type="text" name="serverAddress" id="serverAddress" value="http://"  />
			</div>
			<p id="serverNewMsg" class="errorMsg">&nbsp;</p>
			<a id="butTestServer" href="#" data-role="button" data-icon="refresh">Test</a>
			<a id="butAddServer" href="#" data-role="button" data-icon="plus">Add Server</a>
		</div>
	</div><!-- /serverNewPg -->

	<div data-role="page" id="configPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1>Configuration</h1>
		</div>
		<span class="errorMsg" id="configStatusErrorMsg"></span>
		<div data-role="content">
			<ul id="ulConfig" data-role="listview" data-inset="true">
			</ul>
		</div>
	</div><!-- /configPg -->
	
	<div data-role="page" id="configDetailPg" data-add-back-btn="true" data-theme="e">
		<div data-role="header">
			<h1 id="titleConfigDetail"></h1>
		</div>
		<span class="errorMsg" id="configDetailErrorMsg"></span>
		<div data-role="content">
			<ul id="ulConfigDetail" data-role="listview" data-inset="true">
			</ul>
		</div>
	</div><!-- /configDetailPg -->
	
	<div data-role="page" id="configEditPg" data-theme="e" data-add-back-btn="true" >
		<div data-role="header">
			<h1>Edit</h1>
		</div>
		<div data-role="content">
			<div id="configEditErrorMsg"></div>
			<div data-role="fieldcontain">
				<label id="configEditKeyLabel" for="configEditKey" class="select">Key: </label>
				<input type="text" name="configEditKey" id="configEditKey" value="value"  />
			</div>
		</div>
		<a id="butConfigEditSave" href="#" data-role="button" data-icon="check">Save</a>
		<a data-rel="back" href="#docPg" data-role="button" data-icon="delete">Cancel</a>
	</div><!-- /configEditPg -->
	
<script type="text/javascript">
function typeOf(value) {
	//['object','array', 'string', 'number', 'boolean', 'null', 'undefined']
    var s = typeof value;
    if (s === 'object') {
        if (value) {
            if (value instanceof Array) {
                s = 'array';
            }
        } else {
            s = 'null';
        }
    }
    return s;
}

$(document).ready(function() {
	$(".fieldListA").live("click", function(){
		//alert('clicked fieldListA id='+this.id)
		//muton.docsStart=0;//reset start for new database
		muton.getDoc(this.id.substring(4));
		$.mobile.changePage ($("#docPg"));
	});
   $(".dbListA").live("click", function(){
		//alert('clicked dbListA anchor id='+this.id)
		muton.docsStart=0;//reset start for new database
		muton.populateDocsList(this.id.substring(3));
		$.mobile.changePage ($("#docListPg"));
	});
   $(".fieldDetailA").live("click", function(){
		//alert('clicked fieldDetailA anchor id='+this.id)
		//move key and value into editPg if string, number or bolean
		
		//TODO  make sure current record is in muton.field, push value into editPg
		//TODO  make sure current record dirty flag, check dirty before leaving page
		var x=this.id.substring(6);
		$("#editKeyLabel").html(x);
		$("#editKey").val(muton.recordCurrent[x]);
		$.mobile.changePage ($("#editPg"));
	});
	
	
   $(".viewsList").live("click", function(){
		var x=this.id.split(',');
		alert('clicked view id='+x);
		var y=muton.views.rows[x[1]].doc.views[x[2]];
		var z=muton.views.rows[x[1]].key;
		//alert(y);
		var url='/'+muton.dbCurrent+'/'+z+'/_view/'+x[2]+'?limit=11'
		alert ('url='+url);
		//muton.populateDocsList(db,view);
		//$.mobile.changePage ($("#editPg"));
	});
		
    //muton.populateDbList(muton.dbListStart,muton.dbListIncrement);
    //muton.populateDocsList("books");
	$("#startDbListPg").live("click", function(){
		muton.populateDbList(muton.dbListStart,muton.dbListIncrement);
	});

	$("#startReplicatePg").live("click", function(){
		muton.populateReplicationPg();
		$("#replicateErrorMsg").html('');
		$("#replicatorEvent").html('');
		$("#replicatorEventUL").listview('refresh');	
	});
	
	$("#butReverse").live("click", function(){
		//alert('reverse me');
		if (muton.isReverse){
			muton.isReverse=false;
			$("#fromSlider-label").html("From");
			$("#toSlider-label").html("To");
		}else{
			muton.isReverse=true;
			$("#fromSlider-label").html("To");
			$("#toSlider-label").html("From");
		}
	});

	$("#butReplicator").live("click", function(){
		//alert('@replicate with continuous='+$("#continuous").val());
		//must not be blank inputs
		//read from
		if ($("select#toSlider")[0].selectedIndex){
			var to=$("#toRemote").val();
		}else{
			var to=$("#toLocal").val();
		}
		if ($("select#fromSlider")[0].selectedIndex){
			var from=$("#fromRemote").val();
		}else{
			var from=$("#fromLocal").val();
		}
		//check isReverse to see direction
		if (muton.isReverse){
			var x=to;
			to=from;
			from=x;
		}
		//TODO add trim to and from
		if (to.length==0 || from.length==0 || to==from){
			$("#replicateErrorMsg").html("You must select two databases.");
		}
		//check continuous - cannot read checkbox, see forum
		//alert("to="+to+" and from="+from);
		//must be logged in
		var url="/_session";
		$.getJSON(url, function(data) {
			if (muton.isSession(data)){
				//alert('clicked anchor id='+this.id)
				var errorMsg="";
					var url="/_replicate";
					var repo={};
					repo.source=from;
					repo.target=to;
					repo.continuous=false;
					if ($("#continuous").attr("checked")){
						repo.continuous=true;
					}
						/*
						POST /_replicate HTTP/1.1
					{"source":"example-database",
					"target":"http://admin:password@127.0.0.1:5984/example-database",
					"continuous":true}
						*/
					$.ajax({
						type: 'POST',
						dataType: 'json',
						data: repo,
						url: url,
						success: function(sdata){
						    $("#replicatorEvent").html("<p>"+sdata+"</p>");	
							$("#replicatorEventUL").listview('refresh');
						}
					});
				$("#replicateErrorMsg").html(errorMsg);	
			}else{
				$("#replicateErrorMsg").html("Admin must be logged in to do this operation.");
			}
		});
	});

	
	$("#butLoginPg").live("click", function(){
		//try login in, if not display error
		$("#loginErrorMsg").html("");
		var x=$.trim($("#password").val());
		var y=$.trim($("#username").val());
		//if either empty, display error
		if (x.length<1 || y.length<1){
			$("#loginErrorMsg").html("Username and password required.");
		}else{
			var url="/_session";
			var login={};
			login.name=y;
			login.password=x;
			$.ajax({
				type: 'POST',
				dataType: 'json',
				data: login,
				url: url,
				failure: function(ldata){
					//Error logging in: Name or password is incorrect.
					$("#loginErrorMsg").html("Error logging in: "+ldata.reason);
				},
				success: function(ldata){
					if (ldata.ok){
						//see if logged in
						$('#loginPg').dialog('close');
					}else{
						//Error logging in: Name or password is incorrect.
						$("#loginErrorMsg").html("Error logging in: "+ldata.reason);
					}
				}
			});
		}
	});

	//previous and next for docList
	$("#butDocListPrevious").live("click", function(){
		muton.docsDescending=true;
		var x=muton.docsStart-muton.docsLimit;
		if (x>=0) {
			muton.docsStart=x;
			muton.populateDocsList(muton.dbCurrent);
		}
	});

	$("#butDocListNext").live("click", function(){
		//alert('next docList');
		muton.docsDescending=false;
		var x=muton.docsStart+muton.docsLimit;
		if (x<muton.docsMax) {
			muton.docsStart=x;
			muton.populateDocsList(muton.dbCurrent);
		}
	});

	//previous and next for dbList
	$("#butDbListPrevious").live("click", function(){
		var x=muton.dbStart-muton.dbLimit;
		if (x>=0) {
			muton.dbStart=x;
			muton.populateDbList();
		}
	});

	$("#butDbListNext").live("click", function(){
		//alert('next dbList');
		var x=muton.dbStart+muton.dbLimit;
		if (x<muton.dbMax) {
			muton.dbStart=x;
			muton.populateDbList();
		}
	});

	$("#butEditSave").live("click", function(){
		//alert('@butEdit Save');
		//dirty flag for record, update field in json, close dialog
		muton.recordCurrentDirty=true;
		var x=$("#editKeyLabel").html();
		muton.recordCurrent[x]=$("#editKey").val();
		muton.populateFieldsList(muton.recordCurrent);
		$.mobile.changePage ($("#docPg"));//close and return to previous page
	});

	$("#butCompactDb").live("click", function(){
		//alert('@butCompactDb db='+muton.dbCurrent);
		var url="/"+muton.dbCurrent+"/_compact";
		var x=$('.compactClass":checked').val();
		//values of database, views, cleanup
		if (x=="views"){
			alert("Compact Views requires focus on a view!");
		}
		if (x=="cleanup"){
			//url view cleanup POST http://localhost:5984/dbname/_view_cleanup
			url="/"+muton.dbCurrent+"/_view_cleanup";
		}
		if (x!="views"){
			$.ajax({
				type: 'POST',
				dataType: 'json',
				url: url,
				success: function(){
					//TODO repopulate dblist - maybe sould be on show event????
				    muton.populateDbList(muton.dbListStart,muton.dbListIncrement);
				}
			});
		}
		$('#compactPg').dialog('close');
	});
	
	$("#butDeleteDb").live("click", function(){
		//alert("@butDeleteDb");
		var url="/_session";
		$.getJSON(url, function(data) {
			if (muton.isSession(data)){
				var url="/"+muton.dbCurrent;
				/*
				$.ajax({
					type: 'DELETE',
					dataType: 'json',
					url: url,
					success: function(){
						//TODO repopulate dblist - maybe sould be on show event????
					}
				});
				*/
				$('#dbDeletePg').dialog('close');
			}else{
				$("#createDbErrorMsg").html("Admin must be logged in to do this operation.");
			}
		});
	});
	
	
	$("#butNewDoc").live("click", function(){
		alert("@butNewDoc");
		//get uuid
		var url="/_uuids?count=1";
		$.ajax({
			type: 'get',
			dataType: 'json',
			url: url,
			success: function(){
				alert ("uuid="+data.uuids[0]);
			}
		});

		$('#dbDeletePg').dialog('close');
	});
	

	//clear interval and set timeout for status page
	//muton.statusInterval is interval in seconds
	$('#statusPg').live('pagebeforeshow',function(event, ui){
		var url="/_session";
		$.getJSON(url, function(data) {
			if (muton.isSession(data)){
				$("#statusErrorMsg").html('');	
				muton.populateStatus();
				muton.status=setInterval(muton.populateStatus,1000*muton.statusInterval);
			}else{
				$("#statusErrorMsg").html("Admin must be logged in to do this operation.");
			}
		});
	});

	$('#statusPg').live('pagehide',function(event, ui){
	  clearInterval(muton.status);
	});

   $("#statusPoll").live("change", function(){
		var x=parseInt($("#statusPoll").val());
		//alert('statusPoll='+x)
		if (x!=muton.statusInterval && x>0 & x<10000){
			muton.statusInterval=x;
			clearInterval(muton.status);
			muton.status=setInterval(muton.populateStatus,1000*muton.statusInterval);
		}
		muton.populateStatus();
	});	
		
	$("#fromSlider").live("change", function(){
		$("#fromLocalDiv").toggle();
		$("#fromRemoteDiv").toggle();
	});
	
	$("#toSlider").live("change", function(){
		$("#toLocalDiv").toggle();
		$("#toRemoteDiv").toggle();
	});
	
	//change number of rows in display
	$('#rowDbPg').live('pageshow',function(event, ui){
		//set radio to current muton.dbLimit
		$(".rowsDbClass").val([muton.dbLimit]);
		//alert('radio = '+ $('.rowsDbClass":checked').val());
		$(".rowsDbClass").checkboxradio("refresh");
	});

	$('#rowDbPg').live('pagehide',function(event, ui){
		//read value to radio, if new value redraw page, set muton.dbLimit
		var x=$('.rowsDbClass":checked').val();
		if (x!=muton.dbLimit){
			muton.dbLimit=x;
			muton.populateDbList();
		}
	});
	$('#jumpDocInput').live('change',function(event,ui){
		var x=$.trim($("#jumpDocInput").val());
		if (x.length>0){
			//alert('TODO accept input only on enter='+x);
			muton.getDoc(x);
			$.mobile.changePage ($("#docPg"));
			$("#jumpDocInput").val('');
		}
	});
	
	//action from dialog for creating new database
	$("#butCreateDb").live("click", function(){
		var url="/_session";
		$.getJSON(url, function(data) {
			if (muton.isSession(data)){
				//alert('clicked anchor id='+this.id)
				var errorMsg="";
				var x=$.trim($("#newDbName").val());
				if (x.length==0){
					errorMsg="Please enter a name.";
				}else{
					//TODO regex to all only legal names (a-z), digits (0-9), or  _, $, (, ), +, -, and /
					var url="/"+x+"/";
					$.ajax({
						type: 'PUT',
						url: url,
						success: function(){
							//TODO repopulate dblist - maybe sould be on show event????
						    muton.populateDbList(muton.dbListStart,muton.dbListIncrement);
							$('#createDbPg').dialog('close');
						}
					});
				}
				$("#createDbErrorMsg").html(errorMsg);	
			}else{
				$("#createDbErrorMsg").html("Admin must be logged in to do this operation.");
			}
		});
	});
	
	$('#createDbPg').live('pagebeforeshow',function(event, ui){
		$("#createDbErrorMsg").html('');
	});
	
	$('#configPg').live('pagebeforeshow',function(event){
		$("#configStatusErrorMsg").html('');
		var url="/_session";
		$.getJSON(url, function(data) {
			if (muton.isSession(data)){
				//populate config
				var errorMsg="";
				var url="/_config";
				$.getJSON(url, function(data2) {
					muton.config=data2;
					var items=[];
					for (var key in data2){
						items.push(key);
					}
					items.sort();
					var x="";
					for (var i=0; i<items.length; i++){
						x=x+'<li class="configList" id="config'+items[i]+'"><a href="#configDetailPg">'+items[i]+'</a></li>';
					}
					$("#ulConfig").html(x).listview('refresh');
				});
			}else{
				$("#ulConfig").html('');
				$("#configStatusErrorMsg").html("Admin must be logged in to do this operation.");
			}
		});
	});
	
   $(".configList").live("click", function(){
		var x=this.id.substring(6);
		//alert("id="+x+" value="+muton.config[x]);
		var items=[];
		for (var key in muton.config[x]){
			items.push(key)
		}
		items.sort();
		var y='';
		for (var i=0; i<items.length; i++){
			y=y+'<li class="configDetailA" id="configField_'+items[i];
			y=y+'"><a href="#configEditPg"><h3 class="ui-li-heading">'+muton.config[x][items[i]]+'</h3><p class="ui-li-desc">'+items[i]+'</p></a></li>';
		}
		$("#ulConfigDetail").html(y).listview('refresh');
		$("#titleConfigDetail").html(x);
	});
	
	
	$("#docViewInput").live("change", function(){
		var x=$("#docViewInput").val();
		//alert("change of docViewInput val="+x);
		switch(x){
			case 'all':
				muton.docsListDesignOnly=false;
				muton.populateDocsList(muton.dbCurrent);
			  break;
			case 'design':
				muton.docsListDesignOnly=true;
				muton.populateDocsList(muton.dbCurrent);
				break;
			case 'temporary':
				//TODO
				break;
			case 'runView':
				//TODO get views, populate runViewsPg, run view when clicked
				$("#runViewsUL").html('');
				var url="/"+muton.dbCurrent+"/_all_docs?startkey=%22_design%2F%22&endkey=%22_design0%22&include_docs=true";
				$.getJSON(url, function(data) {
					//alert('Got json of all views='+data);
					muton.populateRunViews(data);
					//alert('TODO switch to runViewsPg')
				});
				$.mobile.changePage ($("#runViewsPg"));
				break;
			default:
			  //no change at this time, only send value to strings and numbers
		}		
		
	});
	
	$("#butAddServer").live("click", function(){
		//alert("clicked on butAddServer")
		$("#serverNewMsg").html("");//clear message
		//verify fields contain info, push to muton.servers, populate servers
		//read muton.server and populate list
		var x=$.trim($("#serverName").val());
		var xx=$.trim($("#serverAddress").val());
		$("#serverName").val(x);
		$("#serverAddress").val(xx);
		var y={};
		//TODO make certain name is not a duplicate
		if (x.length && xx.length){
			y[x]=xx;
			muton.servers.push(y);
			muton.populateServersList();
			$(".deleteServerCheckbox").checkboxradio(); 
			//close dialog
			$('#serverNewPg').dialog('close')
		}else{
			$("#serverNewMsg").html("Both fields are required");
		}
	});
	
	
	$("#butTestServer").live("click", function(){
		//alert("clicked on butTestServer")
		$("#serverNewMsg").html("");//clear message
		//verify fields contain info, push to muton.servers, populate servers
		//read muton.server and populate list
		var x=$.trim($("#serverName").val());
		var xx=$.trim($("#serverAddress").val());
		$("#serverName").val(x);
		$("#serverAddress").val(xx);
		var y={};
		if (x.length && xx.length){
			//{"couchdb":"Welcome","version":"1.0.2"}
			$.getJSON(xx, function(data) {
				//alert ("okay?="+data.couchdb);
				if (data.couchdb=="Welcome"){
					$("#serverNewMsg").html("This is a couchdb server");
				}else{
					$("#serverNewMsg").html("Not a couchdb server");
				}
				//alert('TODO switch to runViewsPg')
			});
			//alert ("url is="+xx);
		}else{
			$("#serverNewMsg").html("Both fields are required");
		}
	});
	
	$("#butDeleteServer").live("click", function(){
		//alert("@butDeleteServer click")
		var x=[];
		//var y
		//read the checkboxes and delete from muton.servers
		if (confirm("Are you certain you want to delete?")){
			for (var i=0; i<muton.servers.length;i++){
				var name='';
				for (name in muton.servers[i]){
					if (typeof muton.servers[i][name] !== 'function'){
						//display name and hide z[name] which is map
						//y=muton.servers[i][name];
						if ($("#"+name).is(":checked")){
							x.push(i);
						}
					}
				}
			}
			//now delete ever server in x
			if(x.length){
				for (var i=x.length; i>0; i--){
					//delete from array
					muton.servers.splice(i,1);
				}
				$('#serverDeletePg').dialog('close')
			}else{
				alert("You have not selected any servers to delete.");
			}
			
		}
	});
	
});

$('#serverPg').live('pageshow',function(event, ui){
	//read muton.server and populate list
	muton.populateServersList();
	$(".deleteServerCheckbox").checkboxradio(); 
});



var muton={
	serverCurrent: "http://127.0.0.1:5984",
	servers: [{"localhost": "http://127.0.0.1:5984"}],
	docsLimit: 10, 
	docsStart: 0, 
	docsMax: 0, 
	dbLimit: 100,
	dbStart: 0,
	dbMax: 0,
	dbCurrent: "",
	recordCurrent: {},
	recordCurrentDirty: false,
	statusInterval: 5, //default to 5 seconds
	docsListDesignOnly: false,
	isReverse: false,//replication interface
	views: {},
	
	"isSession": function(data, failCallback){
	     //data.userCtx.roles[0] - parse through
	     //callback is optional function on fail
	     for (var i=0; i<data.userCtx.roles.length; i++){
	          if (data.userCtx.roles[i]=="_admin"){
	               return true
	          }
	     }
	     if (arguments[1]){
	          return argument[1];//should return a true or false
	     }else{
	          return false;
	     }
	},
	
	populateRunViews: function(data){
		/*
		{
		    "total_rows": 2,
		    "offset": 0,
		    "rows": [
		        {
		            "id": "_design/muton",
		            "key": "_design/muton",
		            "value": {
		                "rev": "2-adebbb70c0879d62fa6d8197cc5b3e71"
		            },
		            "doc": {
		                "_id": "_design/muton",
		                "_rev": "2-adebbb70c0879d62fa6d8197cc5b3e71",
		                "language": "javascript",
		                "views": {
		                    "test": {
		                        "map": "function(doc) {\u000a  emit(null, doc);\u000a}"
		                    },
		                    "test2": {
		                        "map": "function(doc) {\u000a  emit(null, doc);\u000a\u0009//test2\u000a}"
		                    }
		                }
		            }
		        }
		    ]
		}
		<li data-role="list-divider">Design Doc 1</li>
		<li><a href="#" id="" class="">View 1</a></li>
		<li><a href="#" id="" class="">View 2</a></li>
		
		clicking on a view needs to get you the row and the name
		data.row[i].doc.views.viewname has value of map
		*/
		var name;
		var y;
		var x="";
		var z=[];
		muton.views=data;
		for (var i=0; i<data.rows.length; i++){
			//for each design document insert the document name
			y=data.rows[i].id.substring(8);
			x=x+'<li data-role="list-divider">'+y+'</li>';
			z=[];
			name='';
			for (name in data.rows[i].doc.views){
				if (typeof data.rows[i].doc.views[name] !== 'function'){
					//display name and hide z[name] which is map
					z.push(name);
				}
			}
			z.sort();
			for (var ii=0; ii<z.length; ii++){
					x=x+'<li><a href="#" id="views,'+i+','+z[ii]+'" class="viewsList">'+z[ii]+'</a></li>';
			}
		}
		$("#runViewsUL").html(x);
		$("#runViewsUL").listview('refresh');
	},
	
	populateDbList : function(){
		var url='/_all_dbs';
		$.getJSON(url, function(data) {
			//alert('Got json of all databases='+data);
			var x="";
			muton.dbMax=data.length;
			var y=data.slice(muton.dbStart,muton.dbStart+muton.dbLimit);
			/*
["_users","books","edues","muton","nbi","nbi20100705","nbi_final","nbi_final2","talk","ztemp1","ztemp2","ztemp3","ztemp41","ztemp42"]
			*/
			for (var i=0; i<y.length;i++){
				x=x+'<li class="dbListA" id="db_'+y[i]+'" ><a href="#">'+y[i]+'</a>';
				x=x+'<span id="docCount'+i+'" class="ui-li-count"></span></li>';
			}
			x=x+'<li data-role="list-divider" class="xof">Showing '+(muton.dbStart+1)+'-'+(parseInt(muton.dbStart)+i)+' of '+(parseInt(muton.dbMax))+' databases</li>';
			$("#dbListUL").html(x);
			//get record count for each database
			//TODO callback function is not getting j
			for (var j=0; j<y.length;j++){
				var url='/'+y[j]+'/';
				$.getJSON(url, function(data) {
					$("#docCount"+j).html(data.doc_count);
					var a=j;
				});
			}
			$("#dbListUL").listview('refresh');
		});
	},

		populateReplicationPg : function(){
			//populate drop downs with list of local dbs
			var url='/_all_dbs';
			$.getJSON(url, function(data) {
				//alert('Got json of all databases='+data);
				var x="";
				muton.dbMax=data.length;
				var y=data.slice().sort();
				/*
				<select name="fromLocal" id="fromLocal" data-native-menu="false">
					<option value="standard">Standard: 7 day</option>
					<option value="rush">Rush: 3 days</option>
					<option value="express">Express: next day</option>
					<option value="overnight">Overnight</option>
				</select>
				
				*/
				for (var i=0; i<y.length;i++){
					x=x+'<option value="'+y[i]+'">'+y[i]+'</option>';
				}
				$("#fromLocal").html(x).selectmenu("refresh");
				$("#toLocal").html(x).selectmenu("refresh");
			});
		},
	
	populateDocsList : function(db){
		muton.dbCurrent=db;
		//get all documents for a database in this instance of couchdb, populate list, refresh list
		//_all_docs?startkey="doc2"&limit=2  
		//_all_docs?startkey=%22_design%2F%22&endkey=%22_design0%22&include_docs=true 
			//startkey=?
			//limit will be 10, 25, 50, 100 - hardcoding 10 to start
		/*
		somedatabase/_all_docs?startkey="doc2"&limit=2&descending=true
		
		FIRST TIME
		http://127.0.0.1:5984/muton/_all_docs?limit=11
		NEXT:
		/nbi20100705/_all_docs?descending=false&limit=11&startkey=%2214%22&startkey_docid=14&skip=1
		/nbi20100705/_all_docs/?limit=11&skip=1&descending=false&startkey_docid=14A
		
		PREVIOUS:
		/nbi20100705/_all_docs?descending=true&limit=11&startkey=%2214A%22&startkey_docid=14A&skip=1
		
		docsDescending: false,
		
		*/
		//alert("@populateDocsList="+db);
		url="/"+db+"/_all_docs/?limit="+(muton.docsLimit);
		if (muton.docsListDesignOnly){
			url=url+"&startkey=%22_design%2F%22&endkey=%22_design0%22";
		}
		if (muton.docsStart>0){
			url=url+"&skip=1&descending="+muton.docsDescending
			if (muton.descending){
				url=url+"&startkey_docid="+muton.docIdStart;
			}else{
				url=url+"&startkey_docid="+muton.docIdEnd;
			}
		}
		$.getJSON(url, function(data) {
			//alert('Got json of all databases='+data);
			muton.docsMax=data.total_rows;
			var offset=data.offset;
			var rows=data.rows;
			var x="";
			for (var i=0; i<rows.length;i++){
				
			/*		x=x+'"><a href="#docPg"><h3 class="ui-li-heading">'+y[i].key+'</h3>
					<p class="ui-li-desc">'+y[i].value+'</p></a></li>';
			
			*/	
				
				
				//<li><a id="db_name" href="#docPg">doc id here</a><span class="ui-li-count">47</span></li>
				x=x+'<li class="fieldListA" id="doc_'+rows[i].id
				x=x+'"><a href="#docPg"><h3 class="ui-li-heading">'+rows[i].id+'</h3><p class="ui-li-desc">'+rows[i].value.rev+'</p></a></li>';
			}
			x=x+'<li data-role="list-divider" class="xof">Showing '+(muton.docsStart+1)+'-'+(parseInt(muton.docsStart)+i)+' of '+(parseInt(muton.docsMax))+' documents</li>';
			if (rows.length>0){
				muton.docIdStart=rows[0].id;//needed for next and previous
				muton.docIdEnd=rows[rows.length-1].id;
			}
			$("#docsListUL").html(x).listview('refresh');
			//$.mobile.changePage ($("#docListPg"));
			/*
			{"total_rows":256,"offset":0,"rows":[
			{"id":"1","key":"1","value":{"rev":"14-b6b36469b4e1deb02cae3e358b6d3348"}},
			{"id":"10","key":"10","value":{"rev":"29-3eb82d0e82c7b4a47b0d8c328520ac99"}},
			{"id":"100","key":"100","value":{"rev":"1-70cd178b4fe31b9dbc67e0f217719781"}},
			*/
		});
	},
	
	getDoc: function(docKey){
		muton.docKeyCurrent=docKey;
		//alert("@populateFieldsList="+doc);
		url="/"+muton.dbCurrent+"/"+docKey;
		$.getJSON(url, function(data) {
			//alert('Got json of all fields='+data);
			/* convert to array and sort */
			muton.recordCurrent=data; //keep this state for saving modified
			muton.recordCurrentDirty=false;//reset dirty when new values
			muton.populateFieldsList(data);
		});
	},
	
	populateFieldsList: function(docValue){
		var y=[];//array
		var z, x;
		for (x in docValue){
			z={}; //empty z
			z["key"]=x;
			z["value"] = docValue[x];
			y.push(z);
		}
		y.sort(muton.sortObj);
		x="";
		var v;
		var u;  //y[i].key
		for (var i=0; i<y.length;i++){
			v=muton.printValue(y[i].value);
			if (y[i].key.substring(0,1)=="_"){
				//don't allow edit if system field like _id, _rev
				x=x+'<li id="field_'+y[i].key;
				x=x+'"><h3 class="ui-li-heading">'+v+'</h3><p class="ui-li-desc">'+y[i].key+'</p></li>';
			} else{
				x=x+'<li class="fieldDetailA" id="field_'+y[i].key;
				x=x+'"><a href="#"><h3 class="ui-li-heading">'+v+'</h3><p class="ui-li-desc">'+y[i].key+'</p></a></li>';
			}
		}
		$("#fieldListUL").html(x).listview('refresh');
	},
	
	populateFieldsList2 : function(doc){
		muton.docCurrent=doc;
		//alert("@populateFieldsList="+doc);
		url="/"+muton.dbCurrent+"/"+doc;
		$.getJSON(url, function(data) {
			//alert('Got json of all fields='+data);
			/* convert to array and sort */
			muton.recordCurrent=data; //keep this state for saving modified
			muton.recordCurrentDirty=false;//reset dirty when new values
			var y=[];//array
			for (x in data){
				z={}; //empty z
				z["key"]=x;
				z["value"] = data[x];
				y.push(z);
			}
			y.sort(muton.sortObj);
			var x="";
			var v;
			var u;  //y[i].key
			for (var i=0; i<y.length;i++){
				v=muton.printValue(y[i].value);
				if (y[i].key.substring(0,1)=="_"){
					//don't allow edit if system field like _id, _rev
					x=x+'<li id="field_'+y[i].key;
					x=x+'"><h3 class="ui-li-heading">'+v+'</h3><p class="ui-li-desc">'+y[i].key+'</p></li>';
				} else{
					x=x+'<li class="fieldDetailA" id="field_'+y[i].key;
					x=x+'"><a href="#editPg" data-rel="dialog"><h3 class="ui-li-heading">'+v+'</h3><p class="ui-li-desc">'+y[i].key+'</p></a></li>';
				}
			}
			$("#fieldListUL").html(x).listview('refresh');
			/*
			{
			    "_id": "1",
			    "_rev": "13-7faae3cad1ca1f8aad8573e0f988ad48",
			    "type": "nbi",
			    "isArchive": false,
			    "nbiNo": "1",
			...
			*/
		});
	},
	
	populateServersList : function(doc){
		//using muton.servers populate serversPg
		//servers: [{"localhost": "http://127.0.0.1:5984"}],
		var x='';
		var xx='';
		var y;
		var yy;
		for (var i=0; i<muton.servers.length;i++){
			for (name in muton.servers[i]){
				if (typeof muton.servers[i][name] !== 'function'){
					//display name and hide z[name] which is map
					yy=name
					y=muton.servers[i][name]
				}
			}
			//<li class="serverListA"  id="http://127.0.0.1:5984"><a href="#startPg">localhost</a></li>
			x=x+'<li class="serverListA" id="'+y+'"><a href="#startPg">'+yy+'</a></li>'
			xx=xx+'<input type="checkbox" class="deleteServerCheckbox" name="'+yy+'" id="'+yy+'" value="'+i+'" /><label for="'+yy+'">'+yy+'</label>';
		}
		$("#serverListUL").html(x).listview('refresh')
		$("#serverDeleteGroup").html(xx);
		//$(".deleteServerCheckbox").checkboxradio("refresh"); 
	},
	
	
	'sortObj': function (a,b){
		//Compare "a" and "b" in some fashion, and return -1, 0, or 1
		var keyA=a.key.toLowerCase(), keyB=b.key.toLowerCase()
		if (keyA < keyB){ //sort string ascending
			return -1
		}
		if (keyA > keyB){
			return 1
		}
	 	return 0 //default return value (no sorting)
	},
	'printValue' : function(x){
		//look at value to see if //['object','array', 'string', 'number', 'boolean', 'null', 'undefined']
		//return value if string, number or boolean - otherwise return typeOf string
		var y=typeOf(x);
		switch(y){
			case 'string':
			  y='"'+x+'"';
			  break;
			case 'number':
			  y=x;
			  break;
			case 'boolean':
			  y=x;
			  break;
			default:
			  //no change at this time, only send value to strings and numbers
		}
		return y
	},
	
	'populateStatus' : function(){
		var x="";
		//$("#statusPoll").val(muton.statusInterval);
		var url="/_active_tasks";
		$.getJSON(url, function(data) {
			//alert('Got json of all active tasks');
			for (var i=0; i<data.length;i++){
				x=x+'<li><h3 class="ui-li-heading">'+data[i].type+'</h3><p class="ui-li-desc">'+data[i].task;
				x=x+'</p><p class="ui-li-aside">'+data[i].pid;
				x=x+'</p><p class="ui-li-desc">'+data[i].status+'</p></li>';
			}
			if (i==0){
				x="<li>No tasks running</li>";
			}
			$("#statusListUL").html(x).listview('refresh');
		});
	}
}
/*
{"db_name":"nbi_final","doc_count":255,"doc_del_count":13,"update_seq":268,"purge_seq":0,"compact_running":false,"disk_size":14397537,"instance_start_time":"1307067097241345","disk_format_version":5,"committed_update_seq":268}
*/

</script>

</body></html>
